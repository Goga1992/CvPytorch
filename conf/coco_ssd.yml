EXPERIMENT_NAME: 'Coco_SSD'

#########################################
# Dataset / Transforms Configurations
#########################################
DATASET:
  CLASS: 'src.data.datasets.coco.CocoDetection'
  DICTIONARY: 'conf/dicts/coco_dict.yml'
  DICTIONARY_NAME: 'DET_CLASSES'
  BACKGROUND_AS_CATEGORY: True

  TRAIN:
    IMG_DIR: '/home/lmin/data/coco/images/train2017'
    IMG_SUFFIX: '*.jpg'
    INDICES: ''
    SHUFFLE: True
    BATCH_SIZE: 32
    NUM_WORKER: 8
    LOAD_NUM: 1
    LABELS:
      DET_DIR: '/home/lmin/data/coco/annotations'
      DET_SUFFIX: '.xml'
      SEG_DIR: '/home/lmin/data/coco/annotations'
      SEG_SUFFIX: '*.png'
    TRANSFORMS:
      FilterAndRemapCocoCategories: { categories: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 27, 28, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 67, 70, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 84, 85, 86, 87, 88, 89, 90], remap: True }
      ConvertCocoPolysToMask:
      # ColorJitter: { p: 1, brightness: 0.125, contrast: [0.5, 1.5], saturation: [0.5, 1.5], hue: 0.05 }
      RandomResizedCrop: { size: [300, 300], scale: [0.3, 1.0], ratio: [0.5, 2.0], keep_ratio: False }
      RandomHorizontalFlip: { p: 0.5 }
      # Resize: { size: [300, 300], keep_ratio: False }
      ToPercentCoords:
      ToTensor: { normalize: False }
      Normalize: { mean: [123, 117, 104], std: [1.0, 1.0, 1.0] }

    TARGET_TRANSFORMS:
      SSDTargetTransform: { image_size: 300, feature_maps: [38, 19, 10, 5, 3, 1],
                            min_sizes: [21, 45, 99, 153, 207, 261], max_sizes: [45, 99, 153, 207, 261, 315],
                            strides: [8, 16, 32, 64, 100, 300], aspect_ratios: [[2], [2, 3], [2, 3], [2, 3], [2], [2]], clip: True,
                            center_variance: 0.1, size_variance: 0.2, iou_threshold: 0.5 }

  VAL:
    IMG_DIR: '/home/lmin/data/coco/images/val2017'
    IMG_SUFFIX: '*.jpg'
    INDICES: ''
    SHUFFLE: False
    BATCH_SIZE: 10
    NUM_WORKER: 10
    LOAD_NUM: 1
    LABELS:
      DET_DIR: '/home/lmin/data/coco/annotations'
      DET_SUFFIX: '.xml'
      SEG_DIR: '/home/lmin/data/coco/annotations'
      SEG_SUFFIX: '*.png'
    TRANSFORMS:
      FilterAndRemapCocoCategories: { categories: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 27, 28, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 67, 70, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 84, 85, 86, 87, 88, 89, 90], remap: True }
      ConvertCocoPolysToMask:
      Resize: { size: [300, 300], keep_ratio: False }
      ToPercentCoords:
      ToTensor: { normalize: False }
      Normalize: { mean: [123, 117, 104], std: [1.0, 1.0, 1.0] }

    TARGET_TRANSFORMS:
      SSDTargetTransform: { image_size: 300, feature_maps: [38, 19, 10, 5, 3, 1],
                            min_sizes: [21, 45, 99, 153, 207, 261], max_sizes: [45, 99, 153, 207, 261, 315],
                            strides: [8, 16, 32, 64, 100, 300], aspect_ratios: [[2], [2, 3], [2, 3], [2, 3], [2], [2]], clip: True,
                            center_variance: 0.1, size_variance: 0.2, iou_threshold: 0.5 }

  ANCHOR:
    SSD_PRIORS: { image_size: 300, feature_maps: [38, 19, 10, 5, 3, 1],
      min_sizes: [21, 45, 99, 153, 207, 261], max_sizes: [45, 99, 153, 207, 261, 315],
      strides: [8, 16, 32, 64, 100, 300], aspect_ratios: [[2], [2, 3], [2, 3], [2, 3], [2], [2]], clip: True }

#########################################
# Model / Evaluator Configurations
#########################################
USE_MODEL:
  CLASS: 'src.models.ssd.SSD'


EVALUATOR:
  NAME: 'coco_detection'
  EVAL_TYPE: 'mIoU'
  EVAL_INTERVALS: 2


#########################################
# Checkpoints / Resume Configurations
#########################################
CHECKPOINT_DIR: 'checkpoints'
N_EPOCHS_TO_SAVE_MODEL: 10
# PRETRAIN_MODEL: 'checkpoints1/Hymenoptera#AntsBees#ClsModel#sgd#MultiStepLR#2020_07_02_17_37_16/Hymenoptera#AntsBees#ClsModel#sgd#MultiStepLR#2020_07_02_17_37_16#autosave#14.pth'
RESUME: False


#########################################
# Devices / Optimizer / Lr_scheduler / Warmup Configurations
#########################################
GPU_IDS: [3]
N_MAX_EPOCHS: 120

INIT_LR: 0.001
BACKBONE_LR: 0.001
SCALE_LR: 0 # 256 # Scale learning rate based on global batch size

OPTIMIZER:
  TYPE: 'SGD' # Adam, RMSprop
  BIAS_PARAMS:
    momentum: 0.9
    weight_decay: 0.0005
  WEIGHT_PARAMS:
    momentum: 0.9
    weight_decay: 0.0005
  BIAS_LR_MULTIPLIER: 1

LR_SCHEDULER:
  TYPE: 'MultiStepLR' # ['StepLR', 'MultiStepLR', 'ReduceLROnPlateau','CosineAnnealingLR']
  MILESTONES: [65, 85]
  MIN_LR: 0.00000001
  GAMMA: 0.1
  POWER: 0.9
  STEP: 10

WARMUP:
  NAME: 'linear'
  ITERS: 500
  FACTOR: 0.33


#########################################
# GRAD_CLIP Configurations
#########################################
GRAD_CLIP:
  TYPE: 'norm'
  VALUE: 0


#########################################
# Logging / Visualization Configurations
#########################################
N_ITERS_TO_DISPLAY_STATUS: 200

## TENSORBOARD
TENSORBOARD: True
TENSORBOARD_LOG_DIR: 'runs'
TENSORBOARD_MODEL: False
TENSORBOARD_WEIGHT: False
TENSORBOARD_IMAGE: False